<!DOCTYPE html>
<html>
<head>
  <title>CSV Upload</title>
  <style>
    #progress-section { margin-top: 20px; }
    #logs { 
      margin-top: 20px; 
      padding: 10px; 
      border: 1px solid #ccc; 
      background: #f9f9f9; 
      max-height: 200px; 
      overflow-y: auto; 
      font-family: monospace; 
      font-size: 13px;
    }
  </style>
</head>
<body>
  <h2>Upload CSV for Processing</h2>
  <form id="upload-form" enctype="multipart/form-data">
    <input type="file" name="file" required />
    <input type="email" name="email" placeholder="Your email" required />
    <button type="submit">Upload</button>
  </form>

  <div id="progress-section" style="display:none;">
    <progress id="progress-bar" max="100" value="0"></progress>
    <p id="progress-text">Waiting for processing...</p>
    <div id="download-link"></div>
    <h3>Job Logs</h3>
    <div id="logs"></div>
  </div>

  <script>
    document.getElementById("upload-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      const res = await fetch("/upload", { method: "POST", body: formData });
      if (!res.ok) {
        alert("Upload failed!");
        return;
      }
      const data = await res.json();
      const jobId = data.job_id;

      document.getElementById("progress-section").style.display = "block";
      startPolling(jobId);
    });

    let pollInterval;
    async function checkProgress(jobId) {
      const res = await fetch(`/progress/${jobId}`);
      if (!res.ok) return;
      const data = await res.json();

      document.getElementById("progress-bar").value = data.progress;
      document.getElementById("progress-text").innerText =
        `Progress: ${data.progress}% (${data.processed_chunks}/${data.total_chunks} chunks)`;

      if (data.status === "done" && data.final_signed_url) {
        clearInterval(pollInterval);
        document.getElementById("download-link").innerHTML =
          `<a href="${data.final_signed_url}" target="_blank">Download Processed CSV</a>`;
      }

      // Fetch logs (last 20)
      const logsRes = await fetch(`/logs/${jobId}?limit=20`);
      if (logsRes.ok) {
        const logsData = await logsRes.json();
        const logsEl = document.getElementById("logs");
        logsEl.innerHTML = logsData.logs
          .map(l => `<div>[${l.time}] ${l.msg}</div>`)
          .join("");
        logsEl.scrollTop = logsEl.scrollHeight; // auto-scroll to bottom
      }
    }

    function startPolling(jobId) {
      pollInterval = setInterval(() => checkProgress(jobId), 5000); // every 5s
    }
  </script>
</body>
</html>
